<!DOCTYPE HTML>
<html lang="ja">
<head>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<meta charset="utf-8">
<title>Icon Maker</title>
</head>

<script>
  function circle_path_d(cx, cy, r, sr, er, large_arc_flag, sweep_flag) {
    let sx = cx + r * Math.cos( sr * (Math.PI / 180) ) ;
    let sy = cy + r * Math.sin( sr * (Math.PI / 180) ) ;
    let ex = cx + r * Math.cos( er * (Math.PI / 180) ) ;
    let ey = cy + r * Math.sin( er * (Math.PI / 180) ) ;
    let result = `M ${sx},${sy} A ${r} ${r} 0 ${large_arc_flag} ${sweep_flag} ${ex},${ey}`;
    return result;
  };

  $(function() {
    init();
    init_page();
    init_on_actions();
    draw();
    inspector();

    $("#circle1").attr("d", circle_path_d(200, 100, 100, 270,  50, 0, 1));
    $("#circle2").attr("d", circle_path_d(200, 100, 100,  60, 160, 0, 1));
    $("#circle3").attr("d", circle_path_d(200, 100, 100, 180, 250, 0, 1));

    $("#src").val($("svg").html());
    var degree = 0;
    setInterval(function(){
      degree = ++degree % 360;
      $("#circle1").attr("d", circle_path_d(200, 100, 100, (degree + 270) % 360, (degree +  50) % 360, 0, 1));
      $("#circle2").attr("d", circle_path_d(200, 100, 100, (degree +  60) % 360, (degree + 160) % 360, 0, 1));
      $("#circle3").attr("d", circle_path_d(200, 100, 100, (degree + 180) % 360, (degree + 250) % 360, 0, 1));
    }, 10);

    $("#circle4").on("click", function() {alert("Click")})
  });
</script>


<style>
#preview {
  width:  400px;
  height: 400px;
  background-color: silver;
}

.area {
  position: absolute;
}

#area-preview {
  width:  400px;
  height: 400px;
  left: 20px;
  top:  20px;
}

#area-editor {
  width:  400px;
  height: 400px;
  background-color: lightgreen;
  left: 440px;
  top:  20px;
}

#area-inspector {
  position: absolute;
  top: 440px;
  left: 20px;
}
</style>

<script>
  function init() {
    g_default_initial = "O";
    g_default_fill    = "pink";
    g_default_stroke  = "orange";
    g_default_stroke_width  = "4px";
    g_default_font_weight  = "normal";
    g_default_font_family  = "MS PMincho";
    g_initial_x = 200;
    g_initial_y = 200;
    g_font_size = 200;
    g_initial_rotate = 0;

    g_svg_format_header = '<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg">'
    g_svg_format_footer = '</svg>'
  };

  function init_page() {
    let raw = location.search;
    let values = raw.split('?')[1];
    if (!values) return;
    values.split("&").forEach(function(kv){
      let s = kv.split("=");
      if (s.length != 2) return;
      let key   = s[0];
      let value = s[1];
      $(`#${key}`).val(unescape(value));
    });
  }

  function init_on_actions() {
    $("#inspector_toggle").on("click", function() {
      $("#inspector").toggle();
    });
    $(document).on("change", ".console", draw);
    $(document).on("input", ".console", draw);
    $("#save").on("click", turn_the_page);
    $("#reset").on("click", reset);
    $("#download").on("click", download);
    $("#download_png").on("click", function(){svg2png($("#preview"));});
  };

  function download() {
    let data = g_svg_format_header + $("#inspector").val() + g_svg_format_footer;
    let blob = new Blob([data], {"type": "image/svg+xml"});
    $("body").append("<a id='image-file' type='application/octet-stream' href='"
                       + window.URL.createObjectURL(blob) + "' download='test.svg'>Donload SVG</a>");
    $("#image-file")[0].click();
    $("#image-file").remove();
  };

  function draw() {
    let params = values();

    $("#preview").empty();

    make_svg_text(params).appendTo("#preview");
    svg_refresh($("#preview"));
    inspector();
  };

  function make_svg_text(params) {
    let p = $('<text>', {"id": "svg-initial"});
    p.attr("x", g_initial_x + Number(params["position_x"]));
    p.attr("y", g_initial_y + Number(params["position_y"]));
    p.attr("font-family", params["font"] || g_default_font_family);
    p.attr("font-size",  Number(params["size"]) || g_font_size);
    p.attr("text-anchor", "middle");
    p.attr("dominant-baseline", "central");
    p.attr("stroke-linejoin", "round");
    p.attr("rotate", params["rotate"] || g_initial_rotate);
    p.css("font-weight", params["font_weight"] || g_default_font_weight);
    p.css("fill", params["fill"] || g_default_fill);
    p.css("stroke",  params["stroke"] || g_default_stroke);
    p.css("stroke-width", params["stroke_width"] || g_default_stroke_width);
    p.text(params["initial"] || g_default_initial);
    return p;
  };

  function svg_refresh(elm) {
    elm.html(elm.html());
  };

  function values() {
    var r = new Array;
    $(".console").each(function(){
      r[$(this).prop("id")] = $(this).val();
    });
    return r;
  };

  function inspector() {
    $("#inspector").html($("#preview").html());
  };

  function turn_the_page() {
    let params = "?";
    let forms = values();
    Object.keys(forms).forEach(function(key) {
      console.log(key, forms[key]);
      params += `${key}=${escape(forms[key])}&`
    });
    location.search = params;
  };

  function reset() {
    location.search = "";
  };

  function svg2png(svgElement) {
    let width = svgElement.width();
    let height = svgElement.height();
    $('<canvas>', {"id": "canvas1", "width": width, "height": height}).appendTo("body");
    let canvas = $("#canvas1")[0];
    let ctx = canvas.getContext("2d");

    let svg = $("#preview"); svg.attr("viewBox", "0 0 " + width + " " + height); 
    let svgData = new XMLSerializer().serializeToString(svg[0])
    let imgsrc = "data:image/svg+xml;charset=utf-8;base64," + btoa(unescape(encodeURIComponent(svgData)));

    let image = new Image();
    image.onload = function(){
      ctx.drawImage(image, 0, 0);
      $("body").append("<a id='image-file' type='application/octet-stream' href='"
                         + canvas.toDataURL("image/png") + "' download='test.png'>Donload PNG</a>");
      $("#image-file")[0].click();

      $("#canvas1").remove();
      $("#image-file").remove();
    }
    image.src = imgsrc;
  }
</script>

<body>
  <div id="area-all">

    <div id="area-preview" class="area">
      <svg id="preview">
      </svg>
    </div>

    <div id="area-editor" class="area">
      <label for="initial">Initial</label>
      <input class="console" type="text" id="initial" name="my_name" value="O" size="2" maxlength="2" />
      <br>
      <label for="font">Font</label>
      <input class="console" type="text" id="font" name="my_name" size="16" maxlength="16" />
      <label for="font_weight">font_weight</label>
      <input class="console" type="text" id="font_weight" name="my_name" value="normal" size="8" maxlength="8" />
      <br>
      <label for="size">size</label>
      <input class="console" type="number" id="size" name="my_name" value="200" mix="0" max="400"/>
      <br> <label for="position_x">position_x</label>
      <input class="console" type="number" id="position_x" name="my_name" value="0" min="-99" max="99"/>
      <br>
      <label for="position_y">position_y</label>
      <input class="console" type="number" id="position_y" name="my_name" value="0" min="-99" max="99"/>
      <br>
      <label for="fill">fill</label>
      <input class="console" type="text" id="fill" name="my_name" value="pink" size="16" maxlength="16"/>
      <br>
      <label for="stroke">stroke</label>
      <input class="console" type="text" id="stroke" name="my_name" value="orange" size="16" maxlength="16"/>
      <label for="position_y">stroke_width</label>
      <input class="console" type="number" id="stroke_width" name="my_name" value="4" min="0" max="99"/>
      <br>
      <label for="rotate">rotate</label>
      <input class="console" type="number" id="rotate" name="my_name" value="0" min="-180" max="180"/>
      <br>
      <button id="save" type="button">SAVE</button>
      <button id="reset" type="button">RESET</button>
      <br>
      <a id="download" href="#" download="test.svg">DOWNLOAD</a>
      <a id="download_png" href="#" download="test.png">DOWNLOAD_PNG</a>
    </div>

    <div id="area-inspector" class="area">
      <div>
        <button id="inspector_toggle">Inspector</button>
      </div>
      <textarea id="inspector" cols=120 rows=20 readonly>
      </textarea>
    </div>

  </div>
</body>

